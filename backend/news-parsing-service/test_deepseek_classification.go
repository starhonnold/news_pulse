package main

import (
	"context"
	"fmt"
	"os"
	"strings"
	"time"

	"news-parsing-service/internal/services"

	"github.com/sirupsen/logrus"
)

func main() {
	// –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
	apiKey := os.Getenv("DEEPSEEK_API_KEY")
	if apiKey == "" {
		fmt.Println("–û—à–∏–±–∫–∞: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω DEEPSEEK_API_KEY")
		fmt.Println("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: export DEEPSEEK_API_KEY=your_api_key")
		os.Exit(1)
	}

	testNews := []services.DeepSeekNewsItem{
		{
			Index:       0,
			Title:       "–ü—É—Ç–∏–Ω –ø–æ–¥–ø–∏—Å–∞–ª —É–∫–∞–∑ –æ –Ω–æ–≤—ã—Ö —Å–∞–Ω–∫—Ü–∏—è—Ö",
			Description: "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –†–æ—Å—Å–∏–∏ –ø–æ–¥–ø–∏—Å–∞–ª —É–∫–∞–∑ –æ –≤–≤–µ–¥–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Å–∞–Ω–∫—Ü–∏–π –ø—Ä–æ—Ç–∏–≤ –∑–∞–ø–∞–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω",
			Content:     "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –†–æ—Å—Å–∏–∏ –í–ª–∞–¥–∏–º–∏—Ä –ü—É—Ç–∏–Ω –ø–æ–¥–ø–∏—Å–∞–ª —É–∫–∞–∑ –æ –≤–≤–µ–¥–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Å–∞–Ω–∫—Ü–∏–π –ø—Ä–æ—Ç–∏–≤ –∑–∞–ø–∞–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω. –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥ –∏–∑ —Å—Ç—Ä–∞–Ω, –∫–æ—Ç–æ—Ä—ã–µ –≤–≤–µ–ª–∏ —Å–∞–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤ –†–æ—Å—Å–∏–∏.",
			Categories:  []string{"–ø–æ–ª–∏—Ç–∏–∫–∞", "—Ä–æ—Å—Å–∏—è"},
		},
		{
			Index:       1,
			Title:       "–ù–æ–≤—ã–π iPhone 15 –ø–æ–ª—É—á–∏–ª —É–ª—É—á—à–µ–Ω–Ω—É—é –∫–∞–º–µ—Ä—É",
			Description: "Apple –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –Ω–æ–≤—ã–π iPhone 15 —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∫–∞–º–µ—Ä –∏ –Ω–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º A17 Pro",
			Content:     "Apple –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ –Ω–æ–≤—ã–π iPhone 15 —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∫–∞–º–µ—Ä –∏ –Ω–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º A17 Pro. –°–º–∞—Ä—Ç—Ñ–æ–Ω –ø–æ–ª—É—á–∏–ª —Ç–∏—Ç–∞–Ω–æ–≤—ã–π –∫–æ—Ä–ø—É—Å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É USB-C.",
			Categories:  []string{"—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "apple"},
		},
		{
			Index:       2,
			Title:       "–†–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã –∑–∞–≤–æ–µ–≤–∞–ª–∏ –∑–æ–ª–æ—Ç–æ –Ω–∞ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –º–∏—Ä–∞",
			Description: "–†–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã –∑–∞–≤–æ–µ–≤–∞–ª–∏ –∑–æ–ª–æ—Ç—ã–µ –º–µ–¥–∞–ª–∏ –Ω–∞ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –º–∏—Ä–∞ –ø–æ –ª–µ–≥–∫–æ–π –∞—Ç–ª–µ—Ç–∏–∫–µ",
			Content:     "–†–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã –ø–æ–∫–∞–∑–∞–ª–∏ –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –º–∏—Ä–∞ –ø–æ –ª–µ–≥–∫–æ–π –∞—Ç–ª–µ—Ç–∏–∫–µ, –∑–∞–≤–æ–µ–≤–∞–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–æ–ª–æ—Ç—ã—Ö –º–µ–¥–∞–ª–µ–π.",
			Categories:  []string{"—Å–ø–æ—Ä—Ç", "—Ä–æ—Å—Å–∏—è"},
		},
		{
			Index:       3,
			Title:       "–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –≤—ã—Ä–æ—Å –¥–æ 95 —Ä—É–±–ª–µ–π",
			Description: "–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –∫ —Ä—É–±–ª—é –≤—ã—Ä–æ—Å –¥–æ 95 —Ä—É–±–ª–µ–π –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–µ",
			Content:     "–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –∫ —Ä—É–±–ª—é –≤—ã—Ä–æ—Å –¥–æ 95 —Ä—É–±–ª–µ–π –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–µ. –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–≤—è–∑—ã–≤–∞—é—Ç —Ä–æ—Å—Ç —Å –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å—é.",
			Categories:  []string{"—ç–∫–æ–Ω–æ–º–∏–∫–∞", "–≤–∞–ª—é—Ç–∞"},
		},
		{
			Index:       4,
			Title:       "–í –ú–æ—Å–∫–≤–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å –Ω–æ–≤–∞—è –≤—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞",
			Description: "–í –¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–æ–π –≥–∞–ª–µ—Ä–µ–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å –≤—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞",
			Content:     "–í –¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–æ–π –≥–∞–ª–µ—Ä–µ–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å –º–∞—Å—à—Ç–∞–±–Ω–∞—è –≤—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ä–∞–±–æ—Ç—ã –≤–µ–¥—É—â–∏—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ —Å—Ç—Ä–∞–Ω—ã.",
			Categories:  []string{"–∫—É–ª—å—Ç—É—Ä–∞", "–∏—Å–∫—É—Å—Å—Ç–≤–æ"},
		},
	}

	fmt.Println("üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ DeepSeek API")
	fmt.Println("üìä –ú–æ–¥–µ–ª—å: deepseek-chat")
	fmt.Println("üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.07/1M –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤, $1.10/1M –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤")
	fmt.Println(strings.Repeat("=", 60))

	// –°–æ–∑–¥–∞–µ–º logger
	logger := logrus.New()
	logger.SetLevel(logrus.InfoLevel)

	// –°–æ–∑–¥–∞–µ–º DeepSeek –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π
	classifier := services.NewDeepSeekNewsClassifier(apiKey, logger)

	ctx, cancel := context.WithTimeout(context.Background(), 90*time.Second)
	defer cancel()

	startTime := time.Now()
	results, err := classifier.ClassifyNewsBatch(ctx, testNews)
	duration := time.Since(startTime)

	if err != nil {
		fmt.Printf("‚ùå –û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: %v\n", err)
		os.Exit(1)
	}

	fmt.Printf("‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ %s\n", duration)
	fmt.Println(strings.Repeat("-", 60))

	// –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
	categories := classifier.GetAvailableCategories()

	for i, result := range results {
		if result.Error != nil {
			fmt.Printf("‚ùå –ù–æ–≤–æ—Å—Ç—å %d: –û—à–∏–±–∫–∞ - %v\n", i+1, result.Error)
		} else {
			categoryName := "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"
			if name, exists := categories[result.CategoryID]; exists {
				categoryName = name
			}

			fmt.Printf("üì∞ –ù–æ–≤–æ—Å—Ç—å %d: %s\n", i+1, truncateForDisplay(testNews[i].Title, 50))
			fmt.Printf("   üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: %s (ID: %d)\n", categoryName, result.CategoryID)
			fmt.Printf("   üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: %.2f\n", result.Confidence)
			fmt.Printf("   üìù –û–ø–∏—Å–∞–Ω–∏–µ: %s\n", truncateForDisplay(testNews[i].Description, 80))
		}
		fmt.Println()
	}

	// –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
	inputTokens := len(buildPromptForEstimation(testNews)) / 4
	outputTokens := len(fmt.Sprintf("%v", results)) / 4
	estimatedCost := float64(inputTokens)/1000000*0.07 + float64(outputTokens)/1000000*1.10

	fmt.Println(strings.Repeat("=", 60))
	fmt.Printf("üí∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: %d –≤—Ö–æ–¥–Ω—ã—Ö, %d –≤—ã—Ö–æ–¥–Ω—ã—Ö, %d –≤—Å–µ–≥–æ\n", inputTokens, outputTokens, inputTokens+outputTokens)
	fmt.Printf("üíµ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $%.4f\n", estimatedCost)
	fmt.Printf("üìä –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –Ω–æ–≤–æ—Å—Ç—å: $%.4f\n", estimatedCost/float64(len(testNews)))

	fmt.Println("\nüèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
	fmt.Println("\nüí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: DeepSeek API —Å –º–æ–¥–µ–ª—å—é deepseek-chat")
	fmt.Println("   - –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π")
	fmt.Println("   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 12 –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
	fmt.Println("   - –û—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏")
}

// truncateForDisplay –æ–±—Ä–µ–∑–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤—ã–≤–æ–¥–∞
func truncateForDisplay(s string, maxLen int) string {
	if len(s) <= maxLen {
		return s
	}
	return s[:maxLen] + "..."
}

// buildPromptForEstimation —Å–æ–∑–¥–∞–µ—Ç —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
func buildPromptForEstimation(news []services.DeepSeekNewsItem) string {
	var newsList strings.Builder
	for i, item := range news {
		newsList.WriteString(fmt.Sprintf("%d. –ó–∞–≥–æ–ª–æ–≤–æ–∫: %s\n", i+1, item.Title))
		if item.Description != "" {
			newsList.WriteString(fmt.Sprintf("   –û–ø–∏—Å–∞–Ω–∏–µ: %s\n", item.Description))
		}
		if item.Content != "" {
			newsList.WriteString(fmt.Sprintf("   –ö–æ–Ω—Ç–µ–Ω—Ç: %s\n", item.Content))
		}
		if len(item.Categories) > 0 {
			newsList.WriteString(fmt.Sprintf("   RSS –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: %s\n", strings.Join(item.Categories, ", ")))
		}
		newsList.WriteString("\n")
	}

	return fmt.Sprintf(`–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

%s

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
–≤1 - –ü–æ–ª–∏—Ç–∏–∫–∞ (–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç, –≤—ã–±–æ—Ä—ã, –ø–∞—Ä–ª–∞–º–µ–Ω—Ç, —Å–∞–Ω–∫—Ü–∏–∏, –¥–∏–ø–ª–æ–º–∞—Ç–∏—è, –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä—Ç–∏–∏)
2 - –≠–∫–æ–Ω–æ–º–∏–∫–∞ (—Ñ–∏–Ω–∞–Ω—Å—ã, –±–∏–∑–Ω–µ—Å, —Ä—ã–Ω–∫–∏, –≤–∞–ª—é—Ç–∞, –±–∞–Ω–∫–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –í–í–ü, —Ç–æ—Ä–≥–æ–≤–ª—è)
3 - –°–ø–æ—Ä—Ç (—Ñ—É—Ç–±–æ–ª, —Ö–æ–∫–∫–µ–π, –±–∞—Å–∫–µ—Ç–±–æ–ª, —Ç–µ–Ω–Ω–∏—Å, –æ–ª–∏–º–ø–∏–∞–¥—ã, —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã, —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è)
4 - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (IT, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –ò–ò, —Ä–æ–±–æ—Ç—ã, —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã, –±–ª–æ–∫—á–µ–π–Ω, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã, —Å—Ç–∞—Ä—Ç–∞–ø—ã)
5 - –ö—É–ª—å—Ç—É—Ä–∞ (–∏—Å–∫—É—Å—Å—Ç–≤–æ, –∫–∏–Ω–æ, –º—É–∑—ã–∫–∞, —Ç–µ–∞—Ç—Ä, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, –≤—ã—Å—Ç–∞–≤–∫–∏, –º—É–∑–µ–∏)
6 - –ù–∞—É–∫–∞ (–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –æ—Ç–∫—Ä—ã—Ç–∏—è, –º–µ–¥–∏—Ü–∏–Ω–∞, –∫–æ—Å–º–æ—Å, —ç–∫–æ–ª–æ–≥–∏—è, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ)
7 - –û–±—â–µ—Å—Ç–≤–æ (—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–µ–º—å—è, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —ç–∫–æ–ª–æ–≥–∏—è, –±—ã—Ç)
8 - –ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è (–∞–≤–∞—Ä–∏–∏, –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è, –î–¢–ü, –ø–æ–∂–∞—Ä—ã, —á—Ä–µ–∑–≤—ã—á–∞–π–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏)

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏
2. –û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
3. –û—Ü–µ–Ω–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç 0.0 –¥–æ 1.0
4. –ï—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –∫ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é 1 (–†–æ—Å—Å–∏—è) —Å –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é

–û—Ç–≤–µ—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "classifications": [
    {"index": 1, "category_id": 2, "confidence": 0.85},
    {"index": 2, "category_id": 3, "confidence": 0.92}
  ]
}`, newsList.String())
}
