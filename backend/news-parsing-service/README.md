# News Parsing Service

Сервис парсинга RSS лент для проекта "Пульс Новостей". Отвечает за автоматический сбор новостей из различных русскоязычных источников.

## Функциональность

- **Автоматический парсинг RSS лент** каждые 5-10 минут
- **Дедупликация новостей** по URL и заголовкам
- **Автоматическая классификация** новостей по категориям
- **Обработка и нормализация** данных из RSS
- **Логирование и мониторинг** процесса парсинга
- **REST API** для управления и мониторинга
- **Health checks** и метрики

## Архитектура

```
├── cmd/
│   └── main.go                 # Точка входа приложения
├── internal/
│   ├── config/                 # Конфигурация
│   ├── database/               # Работа с БД
│   ├── handlers/               # HTTP обработчики
│   ├── models/                 # Модели данных
│   ├── repository/             # Слой данных
│   └── services/               # Бизнес-логика
├── config/
│   └── config.yaml            # Конфигурационный файл
├── Dockerfile                 # Docker образ
└── go.mod                     # Go модули
```

## Установка и запуск

### Локальная разработка

1. **Установка зависимостей:**
```bash
go mod download
```

2. **Настройка конфигурации:**
```bash
cp config/config.yaml config/config.local.yaml
# Отредактируйте config.local.yaml под ваши нужды
```

3. **Запуск сервиса:**
```bash
go run cmd/main.go
```

### Docker

1. **Сборка образа:**
```bash
docker build -t news-parsing-service .
```

2. **Запуск контейнера:**
```bash
docker run -p 8081:8081 \
  -e POSTGRES_HOST=host.docker.internal \
  -e POSTGRES_PASSWORD=your_password \
  news-parsing-service
```

### Docker Compose

Добавьте сервис в `docker-compose.yml`:

```yaml
services:
  news-parsing-service:
    build: ./news-parsing-service
    ports:
      - "8081:8081"
      - "8091:8091"  # Health check
      - "9091:9091"  # Metrics
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - APP_ENV=production
    depends_on:
      - postgres
    restart: unless-stopped
```

## Конфигурация

### Основные параметры

```yaml
server:
  port: 8081
  host: "0.0.0.0"

database:
  host: "postgres"
  port: 5432
  user: "news_pulse_user"
  password: "news_pulse_secure_password_2024"
  dbname: "news_pulse"

parsing:
  interval: "10m"                    # Интервал парсинга
  max_concurrent_parsers: 5          # Макс. одновременных парсеров
  request_timeout: "30s"             # Таймаут запросов
  enable_deduplication: true         # Включить дедупликацию
  batch_size: 100                    # Размер пакета новостей
```

### Переменные окружения

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `APP_ENV` | Окружение (development/production) | development |
| `APP_PORT` | Порт HTTP сервера | 8081 |
| `POSTGRES_HOST` | Хост PostgreSQL | localhost |
| `POSTGRES_PASSWORD` | Пароль PostgreSQL | - |
| `RSS_PARSE_INTERVAL_MINUTES` | Интервал парсинга в минутах | 10 |
| `LOG_LEVEL` | Уровень логирования | info |

## API Endpoints

### Health Check
```
GET /health
```

Возвращает статус здоровья сервиса.

### Статистика парсинга
```
GET /api/stats
```

Возвращает статистику парсинга за последние 24 часа.

### Статус сервиса
```
GET /api/status
```

Возвращает текущий статус сервиса парсинга.

### Запуск парсинга всех источников
```
POST /api/parse/all
```

Запускает парсинг всех активных источников.

### Парсинг конкретного источника
```
POST /api/parse/source?source_id=1
```

Запускает парсинг конкретного источника.

### Валидация RSS ленты
```
POST /api/validate
Content-Type: application/json

{
  "rss_url": "https://example.com/rss"
}
```

Проверяет корректность RSS ленты.

### Информация о RSS ленте
```
POST /api/feed-info
Content-Type: application/json

{
  "rss_url": "https://example.com/rss"
}
```

Возвращает метаданные RSS ленты.

## Мониторинг

### Health Check

Сервис предоставляет health check endpoint на порту 8091:

```bash
curl http://localhost:8091/health
```

### Метрики

Базовые метрики доступны на порту 9091:

```bash
curl http://localhost:9091/metrics
```

### Логирование

Сервис поддерживает структурированное логирование в JSON формате:

```json
{
  "level": "info",
  "msg": "Successfully parsed RSS feed",
  "source_id": 1,
  "source_name": "РИА Новости",
  "items_count": 15,
  "execution_time": "2.5s",
  "time": "2024-01-15T10:30:00Z"
}
```

## Алгоритм работы

1. **Планирование:** Cron задача запускается каждые 10 минут
2. **Получение источников:** Запрос к БД для получения источников, готовых к парсингу
3. **Параллельный парсинг:** Источники обрабатываются параллельно (до 5 одновременно)
4. **Обработка RSS:** Парсинг XML, извлечение данных, очистка HTML
5. **Классификация:** Автоматическое определение категории новости
6. **Дедупликация:** Проверка существования новости в БД
7. **Сохранение:** Пакетная вставка новых новостей
8. **Логирование:** Запись результатов парсинга

## Классификация новостей

Сервис автоматически определяет категорию новости на основе ключевых слов:

- **Политика:** политика, правительство, президент, выборы...
- **Экономика:** экономика, финансы, рубль, банк, инвестиции...
- **Спорт:** спорт, футбол, хоккей, олимпиада, чемпионат...
- **Технологии:** технологии, интернет, ИИ, стартап, разработка...
- **И другие категории**

## Обработка ошибок

Сервис устойчив к ошибкам:

- **Таймауты:** Автоматическое прерывание долгих запросов
- **Недоступные источники:** Логирование и продолжение работы
- **Некорректный RSS:** Валидация и пропуск проблемных лент
- **Ошибки БД:** Retry логика и graceful degradation

## Производительность

### Оптимизации

- **Пакетная вставка** новостей в БД
- **Connection pooling** для БД
- **Параллельная обработка** источников
- **Ограничение размера** RSS лент (10MB)
- **Кеширование** HTTP соединений

### Ограничения ресурсов

- **Память:** ~512MB
- **CPU:** Умеренное использование
- **Сеть:** Зависит от количества источников
- **БД соединения:** До 25 одновременных

## Разработка

### Структура проекта

```
internal/
├── config/          # Конфигурация приложения
├── database/        # Подключение и работа с БД
├── handlers/        # HTTP обработчики
├── models/          # Структуры данных
├── repository/      # Слой доступа к данным
└── services/        # Бизнес-логика
    ├── rss_parser.go         # Парсер RSS лент
    ├── parsing_service.go    # Основной сервис парсинга
    └── category_classifier.go # Классификатор категорий
```

### Добавление нового источника

1. Добавьте запись в таблицу `news_sources`
2. Убедитесь, что RSS лента корректна
3. Настройте интервал парсинга
4. Сервис автоматически начнет парсинг

### Тестирование

```bash
# Запуск тестов
go test ./...

# Тесты с покрытием
go test -cover ./...

# Линтер
golangci-lint run
```

## Troubleshooting

### Частые проблемы

1. **Сервис не парсит источники**
   - Проверьте статус источников в БД
   - Убедитесь, что `last_parsed_at` не блокирует парсинг
   - Проверьте логи на ошибки

2. **Медленный парсинг**
   - Увеличьте `max_concurrent_parsers`
   - Проверьте таймауты запросов
   - Оптимизируйте БД запросы

3. **Ошибки подключения к БД**
   - Проверьте параметры подключения
   - Убедитесь, что PostgreSQL доступен
   - Проверьте количество соединений

### Логи для диагностики

```bash
# Просмотр логов в Docker
docker logs news-parsing-service

# Логи парсинга с фильтрацией
docker logs news-parsing-service | grep "parsing"

# Ошибки
docker logs news-parsing-service | grep "error"
```

## Безопасность

- Запуск от непривилегированного пользователя
- Валидация всех входящих данных
- Ограничение размера HTTP ответов
- Таймауты для предотвращения DoS
- Безопасное хранение паролей БД

## Масштабирование

Для увеличения производительности:

1. **Горизонтальное масштабирование:** Запуск нескольких экземпляров
2. **Разделение источников:** Распределение источников между экземплярами
3. **Кеширование:** Добавление Redis для кеширования результатов
4. **Очереди:** Использование RabbitMQ/Kafka для асинхронной обработки

## Лицензия

MIT License - см. файл LICENSE для деталей.
